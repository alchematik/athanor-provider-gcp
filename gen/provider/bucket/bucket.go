// Code generated by athanor-go.
// DO NOT EDIT.

package bucket

import (
	"context"
	"fmt"
	sdk "github.com/alchematik/athanor-go/sdk/provider/value"
	"github.com/alchematik/athanor-provider-gcp/gen/provider/identifier"
)

type Bucket struct {
	Identifier identifier.BucketIdentifier
	Config     BucketConfig
	Attrs      BucketAttrs
}

func (x Bucket) ToResourceValue() (sdk.Resource, error) {
	id := x.Identifier.ToValue()

	config := x.Config.ToValue()

	attrs := x.Attrs.ToValue()

	return sdk.Resource{
		Identifier: id,
		Config:     config,
		Attrs:      attrs,
	}, nil
}

type BucketGetter interface {
	GetBucket(context.Context, identifier.BucketIdentifier) (Bucket, error)
}

type BucketCreator interface {
	CreateBucket(context.Context, identifier.BucketIdentifier, BucketConfig) (Bucket, error)
}

type BucketUpdator interface {
	UpdateBucket(context.Context, identifier.BucketIdentifier, BucketConfig, []sdk.UpdateMaskField) (Bucket, error)
}

type BucketDeleter interface {
	DeleteBucket(context.Context, identifier.BucketIdentifier) error
}

type BucketHandler struct {
	BucketGetter  BucketGetter
	BucketCreator BucketCreator
	BucketUpdator BucketUpdator
	BucketDeleter BucketDeleter
}

func (h BucketHandler) GetResource(ctx context.Context, id sdk.Identifier) (sdk.Resource, error) {
	if h.BucketGetter == nil {
		return sdk.Resource{}, fmt.Errorf("unimplemented")
	}

	idVal, err := identifier.ParseBucketIdentifier(id)
	if err != nil {
		return sdk.Resource{}, err
	}

	r, err := h.BucketGetter.GetBucket(ctx, idVal)
	if err != nil {
		return sdk.Resource{}, err
	}

	return r.ToResourceValue()
}

func (h BucketHandler) CreateResource(ctx context.Context, id sdk.Identifier, config any) (sdk.Resource, error) {
	if h.BucketCreator == nil {
		return sdk.Resource{}, fmt.Errorf("unimplemented")
	}

	idVal, err := identifier.ParseBucketIdentifier(id)
	if err != nil {
		return sdk.Resource{}, err
	}

	configVal, err := ParseBucketConfig(config)
	if err != nil {
		return sdk.Resource{}, err
	}

	r, err := h.BucketCreator.CreateBucket(ctx, idVal, configVal)
	if err != nil {
		return sdk.Resource{}, err
	}

	return r.ToResourceValue()
}

func (h BucketHandler) UpdateResource(ctx context.Context, id sdk.Identifier, config any, mask []sdk.UpdateMaskField) (sdk.Resource, error) {
	if h.BucketUpdator == nil {
		return sdk.Resource{}, fmt.Errorf("unimplemented")
	}

	idVal, err := identifier.ParseBucketIdentifier(id)
	if err != nil {
		return sdk.Resource{}, err
	}

	configVal, err := ParseBucketConfig(config)
	if err != nil {
		return sdk.Resource{}, err
	}

	r, err := h.BucketUpdator.UpdateBucket(ctx, idVal, configVal, mask)
	if err != nil {
		return sdk.Resource{}, err
	}

	return r.ToResourceValue()
}

func (h BucketHandler) DeleteResource(ctx context.Context, id sdk.Identifier) error {
	if h.BucketDeleter == nil {
		return fmt.Errorf("unimplemented")
	}

	idVal, err := identifier.ParseBucketIdentifier(id)
	if err != nil {
		return err
	}

	return h.BucketDeleter.DeleteBucket(ctx, idVal)
}

type BucketAttrs struct {
	Created string
}

func (x BucketAttrs) ToValue() any {
	return map[string]any{
		"created": sdk.ToType(x.Created),
	}
}

func ParseBucketAttrs(v any) (BucketAttrs, error) {

	m, err := sdk.Map(v)
	if err != nil {
		return BucketAttrs{}, nil
	}

	created, err := sdk.String(m["created"])
	if err != nil {
		return BucketAttrs{}, nil
	}

	return BucketAttrs{
		Created: created,
	}, nil
}

type BucketConfig struct {
	Labels map[string]any
}

func (x BucketConfig) ToValue() any {
	return map[string]any{
		"labels": sdk.ToType(x.Labels),
	}
}

func ParseBucketConfig(v any) (BucketConfig, error) {

	m, err := sdk.Map(v)
	if err != nil {
		return BucketConfig{}, nil
	}

	labels, err := sdk.Map(m["labels"])
	if err != nil {
		return BucketConfig{}, nil
	}

	return BucketConfig{
		Labels: labels,
	}, nil
}
